{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Loan Prediction</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .card {
        transition: all 0.3s ease;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        border: none;
      }

      .card:hover {
        transform: translateY(-4px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
      }
      .card-header {
        background-color: #818cf8 !important; /* Tailwind's indigo-400 */
        color: white !important;
      }
    </style>
  </head>
  <body class="bg-light">
    <div class="container my-5" style="max-width: 900px;">
      <h1 class="text-center mb-3">Loan Prediction</h1>
      <p class="text-center text-muted mb-4">
        Enter loan and applicant details to estimate repayment likelihood.
      </p>

      {% if errors %}
      <div class="alert alert-danger">
        <ul class="mb-0">
          {% for err in errors %}
          <li>{{ err }}</li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}

      <form id="predict-form" method="post" class="needs-validation" novalidate>
        {% csrf_token %}

        <!-- Voice Input -->
        <div class="card mb-4">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Fill form by voice</h5>
          </div>
          <div class="card-body">
            <button type="button" class="btn btn-outline-secondary" id="record-btn">
              üéôÔ∏è Describe your situation
            </button>
            <p id="record-status" class="mt-2 text-muted small"></p>
            <p class="mt-2 mb-0 text-muted small">
              Example: "I earn 36,000 euros per year, want a loan of 10,000 euros at 14% interest.
              I'm single, employed, have a credit score of 720 and the loan is for a car."
            </p>
          </div>
        </div>

        <!-- Financial Information -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Financial Information</h5>
            </div>
          <div class="card-body">
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Annual Income</label>
                <input
                  type="number"
                  class="form-control"
                  name="annual_income"
                  id="annual_income"
                  value="{{ form_data.annual_income }}"
                />
              </div>
              <div class="col-md-6">
                <label class="form-label">Loan Amount</label>
                <input
                  type="number"
                  class="form-control"
                  name="loan_amount"
                  name="loan_amount"
                  value="{{ form_data.loan_amount }}"
                />
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Interest Rate</label>
              <div class="d-flex justify-content-between">
                <small>3.2%</small>
                <small>21.3%</small>
              </div>
              <input
                type="range"
                class="form-range"
                id="interest_rate"
                name="interest_rate"
                min="3.2"
                max="21.3"
                step="0.1"
                value="{{ form_data.interest_rate|default:3.2 }}"
                oninput="document.getElementById('interest_rate_value').innerText = this.value + '%';"
              />
              <div class="text-center mt-1">
                <span id="interest_rate_value">{{ form_data.interest_rate|default:3.2 }}%</span>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Debt-to-Income Ratio</label>
              <div class="d-flex justify-content-between">
                <small>0</small>
                <small>0.63</small>
              </div>
              <input
                type="range"
                class="form-range"
                id="debt_to_income_ratio"
                name="debt_to_income_ratio"
                min="0"
                max="0.63"
                step="0.01"
                value="{{ form_data.debt_to_income_ratio|default:0 }}"
                oninput="document.getElementById('debt_to_income_ratio_value').innerText = this.value;"
              />
              <div class="text-center mt-1">
                <span id="debt_to_income_ratio_value">{{ form_data.debt_to_income_ratio|default:0 }}</span>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Credit Score</label>
              <div class="d-flex justify-content-between">
                <small>400</small>
                <small>850</small>
              </div>
              <input
                type="range"
                class="form-range"
                id="credit_score"
                name="credit_score"
                min="400"
                max="850"
                step="10"
                value="{{ form_data.credit_score|default:400 }}"
                oninput="document.getElementById('credit_score_value').innerText = this.value;"
              />
              <div class="text-center mt-1">
                <span id="credit_score_value">{{ form_data.credit_score|default:400 }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Personal Information -->
        <div class="card mb-4">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Personal Information</h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label">Name and Surname</label>
              <input
                type="text"
                class="form-control"
                name="name_surname"
                id="name_surname"
                value="{{ form_data.name_surname }}"
                placeholder="Enter your full name"
              />
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
          <label class="form-label">Gender</label>
          <select class="form-select" name="gender" id="gender">
            <option value="" {% if form_data.gender == "" %}selected{% endif %}>-- Select --</option>
            <option value="Female" {% if form_data.gender == "Female" %}selected{% endif %}>Female</option>
            <option value="Male" {% if form_data.gender == "Male" %}selected{% endif %}>Male</option>
            <option value="Other" {% if form_data.gender == "Other" %}selected{% endif %}>Other</option>
          </select>
              </div>
              <div class="col-md-6">
          <label class="form-label">Marital Status</label>
          <select class="form-select" name="marital_status" id="marital_status">
            <option value="" {% if form_data.marital_status == "" %}selected{% endif %}>-- Select --</option>
            <option value="Single" {% if form_data.marital_status == "Single" %}selected{% endif %}>Single</option>
            <option value="Married" {% if form_data.marital_status == "Married" %}selected{% endif %}>Married</option>
            <option value="Divorced" {% if form_data.marital_status == "Divorced" %}selected{% endif %}>Divorced</option>
            <option value="Widowed" {% if form_data.marital_status == "Widowed" %}selected{% endif %}>Widowed</option>
          </select>
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-6">
          <label class="form-label">Education Level</label>
          <select class="form-select" name="education_level" id="education_level">
            <option value="" {% if form_data.education_level == "" %}selected{% endif %}>-- Select --</option>
            <option value="High School" {% if form_data.education_level == "High School" %}selected{% endif %}>High School</option>
            <option value="Bachelor's" {% if form_data.education_level == "Bachelor's" %}selected{% endif %}>Bachelor's</option>
            <option value="Master's" {% if form_data.education_level == "Master's" %}selected{% endif %}>Master's</option>
            <option value="PhD" {% if form_data.education_level == "PhD" %}selected{% endif %}>PhD</option>
            <option value="Other" {% if form_data.education_level == "Other" %}selected{% endif %}>Other</option>
          </select>
              </div>
              <div class="col-md-6">
          <label class="form-label">Employment Status</label>
          <select class="form-select" name="employment_status" id="employment_status">
            <option value="" {% if form_data.employment_status == "" %}selected{% endif %}>-- Select --</option>
            <option value="Self-employed" {% if form_data.employment_status == "Self-employed" %}selected{% endif %}>Self-employed</option>
            <option value="Employed" {% if form_data.employment_status == "Employed" %}selected{% endif %}>Employed</option>
            <option value="Unemployed" {% if form_data.employment_status == "Unemployed" %}selected{% endif %}>Unemployed</option>
            <option value="Retired" {% if form_data.employment_status == "Retired" %}selected{% endif %}>Retired</option>
            <option value="Student" {% if form_data.employment_status == "Student" %}selected{% endif %}>Student</option>
          </select>
              </div>
            </div>
          </div>
        </div>

        <!-- Loan Details -->
        <div class="card mb-4">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Loan Details</h5>
          </div>
          <div class="card-body">
            <div class="row mb-3">
              <div class="col-md-6">
          <label class="form-label">Loan Purpose</label>
          <select class="form-select" name="loan_purpose" id="loan_purpose">
            <option value="" {% if form_data.loan_purpose == "" %}selected{% endif %}>-- Select --</option>
            <option value="Other" {% if form_data.loan_purpose == "Other" %}selected{% endif %}>Other</option>
            <option value="Debt consolidation" {% if form_data.loan_purpose == "Debt consolidation" %}selected{% endif %}>Debt consolidation</option>
            <option value="Home" {% if form_data.loan_purpose == "Home" %}selected{% endif %}>Home</option>
            <option value="Education" {% if form_data.loan_purpose == "Education" %}selected{% endif %}>Education</option>
            <option value="Vacation" {% if form_data.loan_purpose == "Vacation" %}selected{% endif %}>Vacation</option>
            <option value="Car" {% if form_data.loan_purpose == "Car" %}selected{% endif %}>Car</option>
            <option value="Medical" {% if form_data.loan_purpose == "Medical" %}selected{% endif %}>Medical</option>
            <option value="Business" {% if form_data.loan_purpose == "Business" %}selected{% endif %}>Business</option>
          </select>
              </div>
              <div class="col-md-6">
          <label class="form-label">Grade / Subgrade</label>
          <select class="form-select" name="grade_subgrade" id="grade_subgrade">
            <option value="" {% if form_data.grade_subgrade == "" %}selected{% endif %}>-- Select --</option>
            {% for grade in grades %}
            <option value="{{ grade }}" {% if form_data.grade_subgrade == grade %}selected{% endif %}>{{ grade }}</option>
            {% endfor %}
          </select>
              </div>
            </div>
          </div>
        </div>

        <div class="text-end">
          <button type="submit" class="btn btn-primary px-4">Predict</button>
        </div>
      </form>

      {% if message %}
      <div class="alert alert-info mt-4 text-center">{{ message }}</div>
      {% endif %}

      {% if prediction_result %}
      <div
        class="card mt-4 {% if prediction_result.approved %}border-success bg-success-subtle{% else %}border-danger bg-danger-subtle{% endif %}"
      >
        <div class="card-body text-center">
          <h4>Prediction Result</h4>
          <p class="mb-1">
            <strong>Status:</strong>
            {% if prediction_result.approved %} Approved {% else %} Not Approved {% endif %}
          </p>
          <p><strong>Probability:</strong> {{ prediction_result.probability }}%</p>
        </div>
      </div>
      {% endif %}

      <div class="card mt-5">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">All Loan Predictions</h5>
        </div>
        <div class="card-body">
          {% if predictions %}
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Name & Surname</th>
                <th>Loan Amount</th>
                <th>Applied (Date)</th>
              </tr>
            </thead>
            <tbody>
              {% for record in predictions|slice:":10" %}
              <tr>
                <td>
                  <a href="{% url 'detail' record.pk %}" class="text-decoration-none text-primary">
                    {{ record.name_surname }}
                  </a>
                </td>
                <td>{{ record.loan_amount }} ‚Ç¨</td>
                <td>{{ record.created_at }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% else %}
          <p class="text-muted mb-0">No records found.</p>
          {% endif %}
        </div>
      </div>


    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'predictions/voice_form.js' %}"></script>
  </body>
</html>
